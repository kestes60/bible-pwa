<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Bible" />
  <meta name="theme-color" content="#ffffff" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; manifest-src 'self'; base-uri 'self'; form-action 'none'; frame-ancestors 'none';" />

  <title>Bible PWA</title>

  <!-- Link to the Web App Manifest -->
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="/icons/icon-192x192.png" />
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />

  <!-- External Stylesheet -->
  <link rel="stylesheet" href="styles/main.css" />
</head>
<body>
  <!-- Offline Indicator Banner -->
  <div class="offline-indicator" id="offlineIndicator" role="status" aria-live="polite" aria-label="Connection status">
    üì° You're offline - showing cached content
  </div>

  <header role="banner" class="app-header">
    <div class="header-left">
      <button class="menu-button" onclick="openBookSelector()" title="Open book selector" aria-label="Open book and chapter navigation">‚ò∞</button>
    </div>

    <div class="header-center">
      <h1 class="app-title">Bible Reader</h1>
      <div class="app-subtitle">
        by Yahtsar
        <span class="version-chip" id="versionChip" onclick="openVersionManager()" title="Tap to manage versions" role="button" tabindex="0" aria-label="Tap to manage Bible versions">WEB</span>
      </div>
      <!-- Version Manager Modal trigger is the version chip above -->
    </div>

    <div class="header-right">
      <div class="font-size-dropdown" aria-label="Adjust font size">
        <button id="fontSizeToggle"
                class="font-size-toggle"
                aria-haspopup="listbox"
                aria-expanded="false"
                title="Adjust text size">
          <span id="fontSizeDisplay" class="font-size-display">A</span>
          <span class="font-size-caret" aria-hidden="true">‚ñæ</span>
        </button>
        <ul id="fontSizeMenu" class="font-size-menu" role="listbox" aria-label="Font size options">
          <li role="option" data-size="small" tabindex="-1">
            <span class="font-size-option font-size-option-small">A</span>
          </li>
          <li role="option" data-size="medium" tabindex="-1">
            <span class="font-size-option font-size-option-medium">A</span>
          </li>
          <li role="option" data-size="large" tabindex="-1">
            <span class="font-size-option font-size-option-large">A</span>
          </li>
        </ul>
      </div>

      <button class="bookmarks-header-btn" onclick="openBookmarksModal()" title="View bookmarks" aria-label="Open bookmarks">‚òÖ</button>

      <button class="history-header-btn" onclick="openReadingHistory()" title="Recent reading history" aria-label="Open reading history">üìú</button>
      <span id="lastReadHint" class="last-read-hint last-read-header-label"></span>

      <button class="settings-header-btn" onclick="openSettingsModal()" title="Settings" aria-label="Open settings">‚öô</button>

      <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle" title="Toggle theme" aria-label="Toggle light/dark theme">‚òÄ Light</button>
    </div>
  </header>

  <div class="chapter-indicator" id="chapterIndicator" role="region" aria-live="polite" aria-label="Current chapter">Loading...</div>
  <p id="currentPlanStatus" class="current-plan-status" aria-live="polite"></p>
  <div id="currentPlanActions" class="current-plan-actions">
    <button id="continuePlanBtn" class="current-plan-button" onclick="continueCurrentBookPlan()" aria-label="Continue reading current book"></button>
  </div>

  <!-- Welcome Banner (first-time only) -->
  <div id="welcomeBanner" class="welcome-banner" aria-live="polite" aria-label="Welcome to Bible Reader">
    <div class="welcome-banner-inner">
      <div class="welcome-banner-text">
        <h2 class="welcome-banner-title">Welcome to Bible Reader</h2>
        <p class="welcome-banner-body">
          Track your reading in each book, bookmark favorite chapters, and back up your progress anytime.
        </p>
        <p class="welcome-banner-hint">
          Tip: Tap ‚òÖ to save a chapter, üìú to see recent reading, and ‚öô to back up your data.
        </p>
      </div>
      <div class="welcome-banner-actions">
        <button type="button" class="welcome-banner-btn" onclick="dismissWelcomeBanner()">
          Got it
        </button>
        <button
          type="button"
          class="welcome-banner-close"
          onclick="dismissWelcomeBanner()"
          aria-label="Dismiss welcome message"
        >
          √ó
        </button>
      </div>
    </div>
  </div>

  <!-- Search Bar -->
  <div class="search-container" id="searchContainer">
    <div class="search-bar">
      <label for="chapterSearchInput" class="search-label">Search this chapter:</label>
      <div class="search-input-wrapper">
        <input
          type="text"
          id="chapterSearchInput"
          class="search-input"
          placeholder="Enter search term..."
          aria-label="Search current chapter"
          autocomplete="off"
          maxlength="100"
        />
        <button
          id="searchBtn"
          class="search-button"
          onclick="performChapterSearch()"
          title="Search"
          aria-label="Search">
          üîç
        </button>
        <button
          id="clearSearchBtn"
          class="search-clear-button"
          onclick="clearChapterSearch()"
          title="Clear search"
          aria-label="Clear search"
          style="display: none;">
          ‚úï
        </button>
      </div>
    </div>
    <div class="search-results" id="searchResults" aria-live="polite" aria-atomic="true"></div>
    <div class="search-navigation" id="searchNavigation" style="display: none;">
      <button id="prevMatchBtn" onclick="goToPreviousMatch()" aria-label="Previous match">‚Üë</button>
      <span id="matchPosition" aria-live="polite" aria-atomic="true">1 of 3</span>
      <button id="nextMatchBtn" onclick="goToNextMatch()" aria-label="Next match">‚Üì</button>
    </div>
  </div>

  <nav class="chapter-nav" aria-label="Chapter navigation">
    <button id="prevBtn" onclick="previousChapter()" aria-label="Go to previous chapter">‚Üê Previous</button>
    <button class="bookmark-button" onclick="toggleBookmark()" title="Bookmark this chapter" aria-label="Toggle bookmark for current chapter">
      <span id="bookmarkIcon">‚òÜ</span>
    </button>
    <button id="nextBtn" onclick="nextChapter()" aria-label="Go to next chapter">Next ‚Üí</button>
  </nav>

  <!-- Single view (default) -->
  <main class="verses-container" id="versesContainer" role="main" aria-label="Bible verses">
    <div class="loading">Loading the book of John...</div>
  </main>

  <!-- Parallel view container (hidden by default) -->
  <div id="parallelContainer" class="parallel-container" style="display: none;" role="main" aria-label="Parallel Bible view">
    <div class="parallel-pane left-pane">
      <h3 id="primaryHeader" class="pane-header">Primary: <span id="primaryVersionName">WEB</span></h3>
      <div id="primaryVersesContainer" class="pane-verses"></div>
    </div>
    <div class="parallel-pane right-pane">
      <h3 id="secondaryHeader" class="pane-header">Secondary: <span id="secondaryVersionName">KJV</span></h3>
      <div id="secondaryVersesContainer" class="pane-verses"></div>
    </div>
  </div>

  <!-- Book Selector Modal -->
  <div class="book-modal-overlay" id="bookModalOverlay" onclick="closeBookSelector(event)" role="dialog" aria-labelledby="bookModalTitle" aria-modal="true">
    <div class="book-modal" onclick="event.stopPropagation()">
      <div class="book-modal-header">
        <h2 id="bookModalTitle">Quick Nav</h2>
        <button class="book-modal-close" onclick="closeBookSelector()" aria-label="Close book navigation">√ó</button>
      </div>

      <div class="testament-tabs" role="tablist" aria-label="Bible testaments">
        <button class="testament-tab active" onclick="switchTestament('OT')" data-testament="OT" role="tab" aria-selected="true" aria-controls="otBooksGrid">OLD TESTAMENT</button>
        <button class="testament-tab" onclick="switchTestament('NT')" data-testament="NT" role="tab" aria-selected="false" aria-controls="ntBooksGrid">NEW TESTAMENT</button>
      </div>

      <div class="books-grid" id="otBooksGrid" role="tabpanel" aria-labelledby="OT">
        <div class="books-3col" id="otBooks"></div>
      </div>

      <div class="books-grid hidden" id="ntBooksGrid" role="tabpanel" aria-labelledby="NT">
        <div class="books-3col" id="ntBooks"></div>
      </div>
    </div>
  </div>

  <!-- Chapter Selector Modal -->
  <div class="chapter-modal-overlay" id="chapterModalOverlay" onclick="closeChapterSelector(event)" role="dialog" aria-labelledby="chapterModalTitle" aria-modal="true">
    <div class="chapter-modal" onclick="event.stopPropagation()">
      <div class="chapter-modal-header">
        <h2 id="chapterModalTitle">Chapters</h2>
        <button class="chapter-modal-back" onclick="closeChapterSelector()" aria-label="Close chapter selection">‚Üê</button>
      </div>
      <div class="chapters-grid" role="region" aria-label="Chapter selection">
        <div class="chapters-5col" id="chaptersContainer"></div>
      </div>
    </div>
  </div>

  <!-- Bookmarks Modal -->
  <div class="bookmarks-modal-overlay" id="bookmarksModalOverlay" onclick="closeBookmarksModal(event)" role="dialog" aria-labelledby="bookmarksModalTitle" aria-modal="true">
    <div class="bookmarks-modal" onclick="event.stopPropagation()">
      <div class="bookmarks-modal-header">
        <h2 id="bookmarksModalTitle">Bookmarks</h2>
        <button class="bookmarks-modal-close" onclick="closeBookmarksModal()" aria-label="Close bookmarks">√ó</button>
      </div>
      <div id="bookmarksContainer" class="bookmarks-list">
        <div class="empty-state">
          <p class="empty-title">You haven't saved any bookmarks yet.</p>
          <p class="empty-hint">Tap ‚òÖ while reading to save a favorite chapter.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Version Manager Modal -->
  <div class="version-manager-overlay" id="versionManagerOverlay" onclick="closeVersionManager(event)" role="dialog" aria-labelledby="versionManagerTitle" aria-modal="true">
    <div class="version-manager-modal" onclick="event.stopPropagation()">
      <div class="version-manager-header">
        <h2 id="versionManagerTitle">Manage Versions</h2>
        <button class="version-manager-close" onclick="closeVersionManager()" aria-label="Close version manager">&times;</button>
      </div>
      <div class="version-manager-content">
        <p class="version-manager-description">Choose which Bible version(s) to keep offline.</p>

        <h3 class="version-manager-section-title">Installed versions</h3>
        <p class="version-manager-hint">Tap an installed version to switch. The "Active" badge shows your current Bible.</p>
        <div id="installedVersionsList" class="installed-versions-list">
          <!-- Populated by initVersionManager() -->
        </div>

        <div class="version-manager-footer">
          <button class="version-manager-browse" disabled aria-disabled="true">
            Browse more versions (coming soon)
          </button>
          <button class="version-manager-close-btn" onclick="closeVersionManager()">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Reading History Modal -->
  <div class="history-modal-overlay" id="historyModalOverlay" onclick="closeReadingHistory(event)" role="dialog" aria-labelledby="historyModalTitle" aria-modal="true">
    <div class="history-modal" onclick="event.stopPropagation()">
      <div class="history-modal-header">
        <h2 id="historyModalTitle">Recent Reading</h2>
        <p id="historyModalSubtitle" class="history-modal-subtitle"></p>
        <button class="history-modal-close" onclick="closeReadingHistory()" aria-label="Close reading history">√ó</button>
      </div>
      <div id="readingHistoryList" class="reading-history-list">
        <div class="empty-state">
          <p class="empty-title">No recent reading yet.</p>
          <p class="empty-hint">Start reading any chapter, and it will appear here automatically.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- What's New Modal -->
  <div class="whats-new-modal-overlay" id="whatsNewOverlay" onclick="closeWhatsNewModal()" role="dialog" aria-labelledby="whatsNewTitle" aria-modal="true">
    <div class="whats-new-modal" onclick="event.stopPropagation()">
      <div class="whats-new-header">
        <h2 id="whatsNewTitle">What's new</h2>
        <button class="whats-new-close" onclick="closeWhatsNewModal()" aria-label="Close what's new">√ó</button>
      </div>
      <div class="whats-new-body">
        <p class="whats-new-intro">
          This update includes several improvements to help you stay in God's Word:
        </p>
        <ul class="whats-new-list">
          <li><strong>Reading history:</strong> View your recent chapters from the üìú history button.</li>
          <li><strong>Current book progress:</strong> "Continue in ‚Ä¶" button keeps you moving through the book you're reading.</li>
          <li><strong>Backup & restore:</strong> Download a backup of your reading data and restore it later from ‚öô Settings.</li>
          <li><strong>Welcome & empty states:</strong> Friendlier screens when you're just getting started.</li>
        </ul>
        <p class="whats-new-footer">
          Thank you for using Bible Reader!
        </p>
      </div>
      <div class="whats-new-actions">
        <button type="button" class="whats-new-primary" onclick="closeWhatsNewModal()">Got it</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="settings-modal-overlay" id="settingsModalOverlay" onclick="closeSettingsModal(event)" role="dialog" aria-labelledby="settingsModalTitle" aria-modal="true">
    <div class="settings-modal" onclick="event.stopPropagation()">
      <div class="settings-modal-header">
        <h2 id="settingsModalTitle">Settings</h2>
        <button class="settings-modal-close" onclick="closeSettingsModal()" aria-label="Close settings">√ó</button>
      </div>
      <div class="settings-modal-content">
        <!-- Accordion Table of Contents -->
        <nav id="settingsToc" class="settings-toc" aria-label="Settings navigation">
          <a href="#reading-prefs" class="toc-link">Preferences</a>
          <a href="#reading-plans" class="toc-link">Plans</a>
          <a href="#backup-restore" class="toc-link">Backup</a>
          <a href="#manage-versions" class="toc-link">Versions</a>
          <a href="#appearance" class="toc-link">Appearance</a>
        </nav>

        <!-- Accordion Sections -->
        <div class="settings-accordion">
          <!-- 1. Reading Preferences -->
          <h3 class="accordion-header" data-target="reading-prefs" aria-expanded="false" aria-controls="reading-prefs">
            <span class="accordion-title">Reading Preferences</span>
            <span class="accordion-chevron" aria-hidden="true">‚ñ∂</span>
          </h3>
          <div id="reading-prefs" class="accordion-content" aria-expanded="false">
            <div class="setting-group">
              <label for="lineHeightSlider">Line Height</label>
              <div class="slider-row">
                <span class="slider-label-min">Tight</span>
                <input type="range" id="lineHeightSlider" min="1.2" max="2.0" step="0.1" value="1.6" aria-label="Adjust line height">
                <span class="slider-label-max">Double</span>
              </div>
              <span id="lineHeightValue" class="slider-value">1.6</span>
              <small class="setting-hint">Adjust spacing between lines for easier reading</small>
              <!-- Preview pane for mobile (shows live line height changes) -->
              <div id="lineHeightPreview" class="line-height-preview">
                <span class="preview-verse-num">16</span> For God so loved the world, that he gave his only begotten Son, that whosoever believeth in him should not perish, but have everlasting life.
                <span class="preview-verse-num">17</span> For God sent not his Son into the world to condemn the world; but that the world through him might be saved.
                <span class="preview-verse-num">18</span> Whoever believes in him is not condemned, but whoever does not believe stands condemned already because they have not believed in the name of God's one and only Son.
              </div>
            </div>
            <!-- Parallel View Toggle -->
            <div class="setting-group parallel-setting">
              <label class="toggle-label">
                <input type="checkbox" id="parallelToggle">
                <span>Enable Parallel View</span>
              </label>
              <button id="parallelVersionPicker" class="parallel-picker-btn" style="display:none;" onclick="openParallelVersionModal()">
                Secondary: <span id="currentSecondaryName">KJV</span> ‚ñæ
              </button>
              <small class="setting-hint">Side-by-side translations (e.g., English + Hebrew/Greek)</small>
            </div>
          </div>

          <!-- 2. Reading Plans -->
          <h3 class="accordion-header" data-target="reading-plans" aria-expanded="false" aria-controls="reading-plans">
            <span class="accordion-title">Reading Plans</span>
            <span class="accordion-chevron" aria-hidden="true">‚ñ∂</span>
          </h3>
          <div id="reading-plans" class="accordion-content" aria-expanded="false">
            <p class="settings-description">
              Track your progress through books or custom plans. More options are coming in future updates.
            </p>
            <div id="readingPlansList" class="reading-plans-list">
              <!-- Populated by renderReadingPlansList() -->
            </div>
          </div>

          <!-- 3. Backup & Restore -->
          <h3 class="accordion-header" data-target="backup-restore" aria-expanded="false" aria-controls="backup-restore">
            <span class="accordion-title">Backup & Restore</span>
            <span class="accordion-chevron" aria-hidden="true">‚ñ∂</span>
          </h3>
          <div id="backup-restore" class="accordion-content" aria-expanded="false">
            <p class="settings-description">
              Download a backup of your Bible Reader data (reading history, plan progress, preferences). You can restore it later if your browser data is cleared.
            </p>
            <div class="settings-buttons">
              <button class="settings-primary-btn" onclick="exportBibleBackup()">Download backup</button>
              <button class="settings-secondary-btn" onclick="openBackupFilePicker()">Restore from backup file</button>
            </div>
            <p class="settings-note">
              Backups are stored only on your device. Restoring will overwrite your current Bible Reader data.
            </p>
            <input type="file" id="backupFileInput" accept="application/json" style="display:none" onchange="handleBackupFileSelected(event)" />
          </div>

          <!-- 4. Manage Versions -->
          <h3 class="accordion-header" data-target="manage-versions" aria-expanded="false" aria-controls="manage-versions">
            <span class="accordion-title">Manage Versions</span>
            <span class="accordion-chevron" aria-hidden="true">‚ñ∂</span>
          </h3>
          <div id="manage-versions" class="accordion-content" aria-expanded="false">
            <p class="settings-description">
              Switch between Bible translations or manage downloaded versions for offline reading.
            </p>
            <div class="settings-buttons">
              <button class="settings-primary-btn" onclick="closeSettingsModal(); openVersionManager();">Open Version Manager</button>
            </div>
          </div>

          <!-- 5. Appearance -->
          <h3 class="accordion-header" data-target="appearance" aria-expanded="false" aria-controls="appearance">
            <span class="accordion-title">Appearance</span>
            <span class="accordion-chevron" aria-hidden="true">‚ñ∂</span>
          </h3>
          <div id="appearance" class="accordion-content" aria-expanded="false">
            <div class="setting-group">
              <label class="toggle-label appearance-toggle">
                <span>Dark Mode</span>
                <button type="button" id="settingsThemeToggle" class="theme-toggle-btn" onclick="toggleTheme()" aria-label="Toggle dark/light theme">
                  <span class="theme-icon">üåô</span>
                </button>
              </label>
              <small class="setting-hint">Switch between light and dark color schemes</small>
            </div>
          </div>
        </div>

        <!-- Footer link -->
        <p class="settings-whats-new-link">
          <button type="button" class="link-button" onclick="openWhatsNewFromSettings()">
            See what's new in this version
          </button>
        </p>
      </div>
    </div>
  </div>

  <!-- Parallel Version Picker Modal -->
  <div class="parallel-version-modal-overlay" id="parallelVersionModalOverlay" onclick="closeParallelVersionModal(event)" role="dialog" aria-labelledby="parallelVersionModalTitle" aria-modal="true">
    <div class="parallel-version-modal" onclick="event.stopPropagation()">
      <div class="parallel-version-modal-header">
        <h2 id="parallelVersionModalTitle">Select Secondary Version</h2>
        <button class="parallel-version-modal-close" onclick="closeParallelVersionModal()" aria-label="Close version picker">√ó</button>
      </div>
      <div class="parallel-version-modal-body">
        <p class="parallel-version-hint">Choose a translation to display alongside your primary version.</p>
        <ul id="parallelVersionList" class="parallel-version-list" role="listbox">
          <!-- Populated by renderParallelVersionList() -->
        </ul>
      </div>
    </div>
  </div>

  <!-- Back to Top Button -->
  <button id="backToTopBtn" class="back-to-top" onclick="scrollToTop()" aria-label="Back to top">‚Üë Top</button>

  <!-- External Scripts -->
  <!-- Load version configuration first (app.js depends on it) -->
  <script src="scripts/config/versions.js"></script>
  <!-- Reading plans & history storage (available as window.BibleReading) -->
  <script src="scripts/storage/reading-plans.js"></script>
  <!-- Main application logic -->
  <script src="scripts/app.js"></script>
</body>
</html>
